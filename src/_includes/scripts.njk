<!-- Navigation Script -->
<script>
    // Mobile menu toggle
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuOpen = mobileMenuBtn.querySelector('.menu-open');
    const menuClose = mobileMenuBtn.querySelector('.menu-close');

    mobileMenuBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
        menuOpen.classList.toggle('hidden');
        menuClose.classList.toggle('hidden');
    });

    // Mobile accordion toggles
    const accordionTriggers = document.querySelectorAll('.mobile-accordion-trigger');
    accordionTriggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
            const content = trigger.nextElementSibling;
            trigger.classList.toggle('open');
            content.classList.toggle('open');
        });
    });

    // Full-width mega menu handling
    const servicesMegaMenu = document.getElementById('services-mega-menu');
    const moreMegaMenu = document.getElementById('more-mega-menu');
    const servicesNavItem = document.querySelector('[data-menu="services"]');
    const moreNavItem = document.querySelector('[data-menu="more"]');

    function closeAllMegaMenus() {
        servicesMegaMenu?.classList.remove('active');
        moreMegaMenu?.classList.remove('active');
        document.querySelectorAll('.nav-trigger').forEach(t => {
            t.classList.remove('active');
            t.setAttribute('aria-expanded', 'false');
        });
    }

    function openMegaMenu(menuType) {
        closeAllMegaMenus();
        if (menuType === 'services' && servicesMegaMenu) {
            servicesMegaMenu.classList.add('active');
            servicesNavItem?.querySelector('.nav-trigger')?.classList.add('active');
            servicesNavItem?.querySelector('.nav-trigger')?.setAttribute('aria-expanded', 'true');
        } else if (menuType === 'more' && moreMegaMenu) {
            moreMegaMenu.classList.add('active');
            moreNavItem?.querySelector('.nav-trigger')?.classList.add('active');
            moreNavItem?.querySelector('.nav-trigger')?.setAttribute('aria-expanded', 'true');
        }
    }

    // Hover behavior for desktop mega menus
    let menuCloseTimeout;

    function handleMenuEnter(menuType) {
        clearTimeout(menuCloseTimeout);
        openMegaMenu(menuType);
    }

    function handleMenuLeave() {
        menuCloseTimeout = setTimeout(() => {
            closeAllMegaMenus();
        }, 150);
    }

    // Nav item hover events
    servicesNavItem?.addEventListener('mouseenter', () => handleMenuEnter('services'));
    servicesNavItem?.addEventListener('mouseleave', handleMenuLeave);
    moreNavItem?.addEventListener('mouseenter', () => handleMenuEnter('more'));
    moreNavItem?.addEventListener('mouseleave', handleMenuLeave);

    // Mega menu hover events (keep menu open when hovering over it)
    servicesMegaMenu?.addEventListener('mouseenter', () => {
        clearTimeout(menuCloseTimeout);
    });
    servicesMegaMenu?.addEventListener('mouseleave', handleMenuLeave);
    moreMegaMenu?.addEventListener('mouseenter', () => {
        clearTimeout(menuCloseTimeout);
    });
    moreMegaMenu?.addEventListener('mouseleave', handleMenuLeave);

    // Click behavior for nav triggers
    servicesNavItem?.querySelector('.nav-trigger')?.addEventListener('click', (e) => {
        e.preventDefault();
        const isOpen = servicesMegaMenu?.classList.contains('active');
        if (isOpen) {
            closeAllMegaMenus();
        } else {
            openMegaMenu('services');
        }
    });

    moreNavItem?.querySelector('.nav-trigger')?.addEventListener('click', (e) => {
        e.preventDefault();
        const isOpen = moreMegaMenu?.classList.contains('active');
        if (isOpen) {
            closeAllMegaMenus();
        } else {
            openMegaMenu('more');
        }
    });

    // Close mega menus when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.nav-item') && !e.target.closest('.mega-menu')) {
            closeAllMegaMenus();
        }
    });

    // Keyboard accessibility for mega menus
    document.querySelectorAll('.nav-trigger').forEach(trigger => {
        trigger.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const menuType = trigger.closest('.nav-item')?.dataset.menu;
                const isOpen = (menuType === 'services' && servicesMegaMenu?.classList.contains('active')) ||
                               (menuType === 'more' && moreMegaMenu?.classList.contains('active'));

                if (isOpen) {
                    closeAllMegaMenus();
                } else {
                    openMegaMenu(menuType);
                }
            }
            if (e.key === 'Escape') {
                closeAllMegaMenus();
            }
        });
    });

    // Hide header on scroll down, show on scroll up
    let lastScrollY = window.scrollY;
    const nav = document.querySelector('nav');

    window.addEventListener('scroll', () => {
        // Close mobile menu on scroll
        if (!mobileMenu.classList.contains('hidden')) {
            mobileMenu.classList.add('hidden');
            menuOpen.classList.remove('hidden');
            menuClose.classList.add('hidden');
        }

        // Close mega menus on scroll
        closeAllMegaMenus();

        if (window.scrollY > lastScrollY && window.scrollY > 100) {
            nav.style.transform = 'translateY(-100%)';
            nav.style.opacity = '0';
        } else {
            nav.style.transform = 'translateY(0)';
            nav.style.opacity = '1';
        }
        lastScrollY = window.scrollY;
    });
</script>
